<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DC-NDC Transition Map</title>
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/gojs@3.0.24/release/go.js"></script>

  <div id="allSampleContent" class="p-4 w-full">





    <link href="https://fonts.googleapis.com/css?family=Poppins:regular,medium,bold&amp;subset=latin,latin-ext"
      rel="stylesheet" type="text/css">
    <style>
      #hidden {
        font: 500 18px Poppins;
        opacity: 0;
      }
    </style>
    <script id="code">

      // This GoJS sample was designed by Synergy Codes, our consultant partner with
      // over a decade of experience and cooperation with the GoJS team.
      // See https://synergycodes.com/gojs/ for more

      // This sample demonstrates polished Node and Link template design,
      // which involves considerable code and opinionated choices.
      // It may be unsuitable as a starting point unless you want to copy these specific styles.
      // As part of your evaluation, the GoJS team is happy to help you craft your own templates.
      // For a more rudimentary family tree, see familyTreeJP.html

      // properties used in bindings,
      // defined to not use simple strings in bindings across application
      const nameProperty = 'name';
      const genderProperty = 'gender';
      const statusProperty = 'status';
      const countProperty = 'count';

      const theme = {
        colors: {
          femaleBadgeBackground: '#FFCBEA',
          maleBadgeBackground: '#A2DAFF',
          femaleBadgeText: '#7A005E',
          maleBadgeText: '#001C76',
          kingQueenBorder: '#FEBA00',
          princePrincessBorder: '#679DDA',
          civilianBorder: '#58ADA7',
          personText: '#383838',
          personNodeBackground: '#FFFFFF',
          selectionStroke: '#485670',
          counterBackground: '#485670',
          counterBorder: '#FFFFFF',
          counterText: '#FFFFFF',
          link: '#686E76'
        },
        fonts: {
          badgeFont: 'bold 12px Poppins',
          birthDeathFont: '14px Poppins',
          nameFont: '500 18px Poppins',
          counterFont: '14px Poppins'
        }
      };

      // toggle highlight on mouse enter/leave
      // this sample also uses highlight for selection, so only unhighlight if unselected
      const onMouseEnterPart = (e, part) => part.isHighlighted = true;
      const onMouseLeavePart = (e, part) => { if (!part.isSelected) part.isHighlighted = false; }
      const onSelectionChange = (part) => { part.isHighlighted = part.isSelected; }

      const STROKE_WIDTH = 3;
      const ADORNMENT_STROKE_WIDTH = STROKE_WIDTH + 1;
      const CORNER_ROUNDNESS = 12;
      const IMAGE_TOP_MARGIN = 20;
      const MAIN_SHAPE_NAME = 'mainShape';
      const IMAGE_DIAMETER = 40;

      const getStrokeForStatus = (status) => {
        switch (status) {
          case 'king':
          case 'queen':
            return theme.colors.kingQueenBorder;
          case 'prince':
          case 'princess':
            return theme.colors.princePrincessBorder;
          case 'civilian':
          default:
            return theme.colors.civilianBorder;
        }
      };

      function strokeStyle(shape) {
        return shape
          .set({
            fill: theme.colors.personNodeBackground,
            strokeWidth: STROKE_WIDTH
          })
          .bind('stroke', statusProperty, status => getStrokeForStatus(status))
          .bindObject('stroke', 'isHighlighted', (isHighlighted, obj) =>
            isHighlighted
              ? theme.colors.selectionStroke
              : getStrokeForStatus(obj.part.data.status))
      }

      function getScreenByStepParam(stepParam, regKeys) {
        if (!stepParam || stepParam.length < 3) return null;

        const screenId = stepParam.slice(0, 3); // Extract first 3 characters

        return regKeys.find(
          item => item.type === "screen" && item.screenId === screenId
        ) || null;
      }
      function extractVisibleText(rawString) {
        if (!rawString) return "";

        // Replace \\ with \
        let str = rawString.replace(/\\\\/g, "\\");

        // Remove specific known control codes
        str = str
          .replace(/\\1b\[[^\]]*m/g, '')          // ANSI escape codes
          .replace(/\\1b\(.|\\1b[@=]?/g, '')       // \1b(1 or \1b@ \1b=
          .replace(/\\0[cdefhlmnprstuvxz]/gi, '')  // \0f, \0c, etc
          .replace(/\\0e[0-9a-zA-Z]+/gi, '')       // \0e190
          .replace(/\\0[0-9a-zA-Z]+/gi, '')        // any \0 followed by chars
          .replace(/\\1b/g, '')                    // leftover \1b
          .replace(/\\./g, '')                     // other unknown escapes
          .replace(/^[0-9A-Z@=]+/, '')             // remove leading noise (like 1AE or 1190@=B01)
          .replace(/\s+/g, ' ')                    // multiple spaces to one
          .trim();

        // console.log('extractVisibleText:', str);
        return str;
      }


      const genderToText = (gender) => (gender === 'M' ? 'MALE' : 'FEMALE');

      const genderToTextColor = (gender) =>
        gender === 'M' ? theme.colors.maleBadgeText : theme.colors.femaleBadgeText;

      const genderToFillColor = (gender) =>
        gender === 'M'
          ? theme.colors.maleBadgeBackground
          : theme.colors.femaleBadgeBackground;

      const personBadge = () =>
        new go.Panel('Auto', {
          alignmentFocus: go.Spot.TopRight,
          alignment: new go.Spot(1, 0, -25, STROKE_WIDTH - 0.5)
        })
          .add(
            new go.Shape({
              figure: 'RoundedRectangle',
              parameter1: CORNER_ROUNDNESS,
              parameter2: 4 | 8, // round only the bottom
              desiredSize: new go.Size(NaN, 22.5),
              stroke: null
            })
              .bind('fill', genderProperty, genderToFillColor),
            new go.TextBlock({
              font: theme.fonts.badgeFont
            })
              .bind('stroke', genderProperty, genderToTextColor)
              .bind('text', genderProperty, genderToText)
          )

      const personBirthDeathTextBlock = () =>
        new go.TextBlock({
          stroke: theme.colors.personText,
          font: theme.fonts.birthDeathFont,
          alignmentFocus: go.Spot.Top,
          alignment: new go.Spot(0.5, 1, 0, -35)
        })
          .bind('text', '', ({ born, death }) => {
            if (!born) return '';
            return `${born} - ${death ?? ''}`;
          })

      // Panel to display the number of children a node has
      const personCounter = () =>
        new go.Panel('Auto', {
          visible: false,
          alignmentFocus: go.Spot.Center,
          alignment: go.Spot.Bottom
        })
          .bindObject('visible', '', (obj) => obj.findLinksOutOf().count > 0)
          .add(
            new go.Shape('Circle', {
              desiredSize: new go.Size(29, 29),
              strokeWidth: STROKE_WIDTH,
              stroke: theme.colors.counterBorder,
              fill: theme.colors.counterBackground
            }),
            new go.TextBlock({
              alignment: new go.Spot(0.5, 0.5, 0, 1),
              stroke: theme.colors.counterText,
              font: theme.fonts.counterFont,
              textAlign: 'center'
            })
              .bindObject('text', '', (obj) => obj.findNodesOutOf().count)
          )
      const linkCountBatch = () =>
        new go.Panel('Auto', {
          visible: false,
          alignmentFocus: go.Spot.Center,
          alignment: go.Spot.Bottom
        })
          .bindObject('visible', '', (obj) => obj.findLinksOutOf().count > 0)
          .add(
            new go.Shape('Circle', {
              desiredSize: new go.Size(29, 29),
              strokeWidth: STROKE_WIDTH,
              stroke: theme.colors.counterBorder,
              fill: theme.colors.counterBackground
            }),
            new go.TextBlock({
              alignment: new go.Spot(0.5, 0.5, 0, 1),
              stroke: theme.colors.counterText,
              font: theme.fonts.counterFont,
              textAlign: 'center'
            })
              .bindObject('text', '', (obj) => {

                console.log('linkCountBatch', obj.findLinksOutOf())
                return obj.findLinksOutOf().count
              })
          )

      function pictureStyle(pic) {
        return pic
          .bind('source', '', ({ status, gender }) => {
            switch (status) {
              case 'king':
              case 'queen':
                return './images/king.svg';
              case 'prince':
              case 'princess':
                return './images/prince.svg';
              case 'civilian':
                return gender === 'M'
                  ? './images/male-civilian.svg'
                  : './images/female-civilian.svg';
              default:
                return './images/male-civilian.svg';
            }
          })
          // The SVG files are different sizes, so this keeps their aspect ratio reasonable
          .bind('desiredSize', 'status', status => {
            switch (status) {
              case 'king':
              case 'queen':
                return new go.Size(30, 20)
              case 'prince':
              case 'princess':
                return new go.Size(28, 20)
              case 'civilian':
              default:
                return new go.Size(24, 24)
            }
          });
      }

      const personImage = () =>
        new go.Panel('Spot', {
          alignmentFocus: go.Spot.Top,
          alignment: new go.Spot(0, 0, STROKE_WIDTH / 2, IMAGE_TOP_MARGIN)
        })
          .add(
            new go.Shape({
              figure: 'Circle',
              desiredSize: new go.Size(IMAGE_DIAMETER, IMAGE_DIAMETER)
            })
              .apply(strokeStyle),
            new go.Picture({ scale: 0.9 })
              .apply(pictureStyle)
          );

      const personMainShape = () =>
        new go.Shape({
          figure: 'RoundedRectangle',
          desiredSize: new go.Size(215, 110),
          portId: '',
          parameter1: CORNER_ROUNDNESS
        })
          .apply(strokeStyle);

      const personNameTextBlock = () =>
        new go.TextBlock({
          stroke: theme.colors.personText,
          font: theme.fonts.nameFont,
          desiredSize: new go.Size(160, 50),
          overflow: go.TextOverflow.Ellipsis,
          textAlign: 'center',
          verticalAlignment: go.Spot.Center,
          toolTip: go.GraphObject.build('ToolTip')
            .add(new go.TextBlock({ margin: 4 }).bind('text', nameProperty)),
          alignmentFocus: go.Spot.Top,
          alignment: new go.Spot(0.5, 0, 0, 25)
        })
          .bind('text', nameProperty)

      const screenBlock = () =>
        new go.Panel("Auto")
          .add(
            new go.Shape("RoundedRectangle", {
              fill: "#f0f0f0",
              strokeWidth: 1
            }).bind("stroke", "type", function (t) {
              return "#ccc";
            }),

            new go.Panel("Vertical").add(
              // Screen ID label (outside the box)
              new go.TextBlock({
                margin: new go.Margin(0, 0, 4, 0), // space below the label
                stroke: "limegreen",               // green text color (bright like ATM)
                font: "bold 10pt monospace",       // bold + monospace for terminal feel
                textAlign: "center"
              }).bind("text", "", function (data) {
                const datumm = getScreenByStepParam(data.STEP_PARAM, regKeys);
                return ` ${datumm.screenId || ' '}`;
              }),
              // ATM-style box with contents
              new go.Panel("Auto").add(
                new go.Shape("Rectangle", {
                  fill: "black",
                  stroke: "black",
                  strokeWidth: 1
                }),
                new go.TextBlock({
                  margin: 8,
                  font: "bold 8pt monospace",
                  stroke: "white",
                  wrap: go.TextBlock.WrapFit,
                  width: 200,
                  lineSpacing: 4,
                  isMultiline: true,
                  textAlign: "left"
                }).bind("text", "", function (data) {
                  const screenData = getScreenByStepParam(data.STEP_PARAM, regKeys);
                  return ` ${extractVisibleText(screenData?.CONTENTS) || ' '}`;
                })
              )
            )

          );

      const stepFuncBlock = () => new go.TextBlock({
        margin: 2,
        font: '10pt monospace',
        stroke: '#007acc'
      }).bind('text', 'STEP_FUNC').bind('visible', 'type', t => t === 'state');

      const stepParamBlock = () =>
        new go.TextBlock({
          margin: 2,
          font: '9pt monospace',
          stroke: '#999'
        })
          .bind('text', 'STEP_PARAM', function (param) {
            if (!param) return '';
            if (param.length < 24) {
              return param.padEnd(24, 'x').match(/.{1,3}/g).join(' ');
            }
            return param.match(/.{1,3}/g).join(' ');
          })
          .bind('stroke', 'STEP_PARAM', function (param) {
            return param && param.length < 24 ? 'red' : '#999';
          })
          .bind('visible', 'type', t => t === 'state');

      const createNodeTemplate = () =>
        new go.Node('Auto', {
          selectionAdorned: false,
          mouseEnter: onMouseEnterPart,
          mouseLeave: onMouseLeavePart,
          selectionChanged: onSelectionChange
        }).add(
          new go.Shape('RoundedRectangle', {
            fill: '#f0f0f0',
            strokeWidth: 2
          }).bind('stroke', 'type', function (t) {
            return t === 'state' ? 'orange' : t === 'screen' ? 'green' : '#ccc';
          }),

          new go.Panel('Vertical')
            .add(
              new go.TextBlock({
                margin: 4,
                font: 'bold 12pt sans-serif',
                stroke: '#333'
              })
                .bind('text', '', function (data) {
                  return `${data.type.toUpperCase()} -  ${data.screenId || ''}`;
                }),

              stepFuncBlock(),

              stepParamBlock(),
              linkCountBatch(),

              // Conditionally show CONTENTS + screenId for screen nodes
              new go.TextBlock({
                margin: 2,
                font: '9pt monospace',
                stroke: '#444'
              }).bind('text', '', function (data) {
                return `CONTENTS: ${data.CONTENTS || ''} `;
              }).bind('visible', 'type', t => t === 'screen'),

              screenBlock().bind('visible', 'STEP_FUNC', t => !skipScreens_STEP_FUNC.includes(t))

            )
        ).bind("visible", "type", t => t === "state"); // 👈 Only visible for 'state'

      // const createNodeTemplate2 = () =>
      //   new go.Node('Spot', {
      //     selectionAdorned: false,
      //     mouseEnter: onMouseEnterPart,
      //     mouseLeave: onMouseLeavePart,
      //     selectionChanged: onSelectionChange
      //   })
      //     .add(
      //       new go.Panel('Spot')
      //         .add(
      //           personMainShape(),
      //           personNameTextBlock(),
      //           personBirthDeathTextBlock()
      //         ),
      //       personImage(),
      //       personBadge(),
      //       personCounter()
      //     )

      const createLinkTemplate = () => {
        return new go.Link({
          selectionAdorned: false,
          routing: go.Routing.Orthogonal,
          layerName: 'Background',
          mouseEnter: onMouseEnterPart,
          mouseLeave: onMouseLeavePart
        })
          .add(
            new go.Shape({
              strokeWidth: 2
            }).bind("stroke", "color")
          )
          .bind("stroke", "color", (c) => c || "#999")
          .add(
            new go.TextBlock({
              font: '8pt monospace',
              segmentOffset: new go.Point(0, -10),
              stroke: '#555'
            })
              .bind('text', 'text')
              .bind('stroke', 'color', (c) => c || "#555")
          )
          .bind(new go.Binding("segmentOffset", "linkIndex", idx => {
            // idx is your link's index, shift vertically by 5px times index
            if (idx == null) return new go.Point(0, 0);
            return new go.Point(0, idx * 5);
          }));
      };

      const initDiagram = (divId) => {
        const diagram = new go.Diagram(divId, {
          layout: new go.TreeLayout({
            angle: 90,
            nodeSpacing: 20,
            layerSpacing: 50,
            layerStyle: go.TreeLayout.LayerUniform,

            // For compaction, make the last parents place their children in a bus
            treeStyle: go.TreeStyle.LastParents,
            alternateAngle: 90,
            alternateLayerSpacing: 35,
            alternateAlignment: go.TreeAlignment.BottomRightBus,
            alternateNodeSpacing: 20
          }),
          'toolManager.hoverDelay': 100,
          linkTemplate: createLinkTemplate(),
          model: new go.TreeModel({ nodeKeyProperty: 'name' })
        });

        diagram.nodeTemplate = createNodeTemplate();
        // const nodes = familyData;
        const nodes = regKeys;
        // diagram.model.addNodeDataCollection(nodes);
        const model = new go.GraphLinksModel();
        model.nodeKeyProperty = "name";      // use 'name' as unique node identifier
        model.linkFromKeyProperty = "from";  // links must have a 'from'
        model.linkToKeyProperty = "to";      // and a 'to'
        model.nodeDataArray = regKeys;       // your nodes
        model.linkDataArray = links;         // your links

        diagram.model = model;

        console.log('nodeDataArray:', diagram.model.nodeDataArray);
        console.log('nodeDataArray links:', links);

        // Initially center on root:
        diagram.addDiagramListener('InitialLayoutCompleted', () => {
          const root = diagram.findNodeForKey('King George V');
          if (!root) return;
          diagram.scale = 0.6;
          diagram.scrollToRect(root.actualBounds);
        });

        // Setup zoom to fit button
        document.getElementById('zoomToFit').addEventListener('click', () => diagram.commandHandler.zoomToFit());

        document.getElementById('centerRoot').addEventListener('click', () => {
          diagram.scale = 1;
          diagram.commandHandler.scrollToPart(diagram.findNodeForKey('King George V'));
        });
      };
      let regKeys = [
        {
          "type": "state",
          "screenId": "016",
          "STEP_FUNC": "NDC_FDK_SWITCH",
          "STEP_PARAM": "501070095185PC1900800OS1"
        },
        {
          "type": "state",
          "screenId": "BP3",
          "STEP_FUNC": "DC_INFORMATION_ENTRY",
          "STEP_PARAM": "B03141137BP5BP3BP1137123"
        },
        {
          "type": "screen",
          "screenId": "B03",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEPLEASE ENTER ACCOUNT NUMBER"
        },
        {
          "type": "state",
          "screenId": "BP4",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "B04141137BP5137255255000"
        },
        {
          "type": "screen",
          "screenId": "B04",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEPLEASE WAIT"
        },
        {
          "type": "state",
          "screenId": "BP5",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "B05141137BP6CIN255255000"
        },
        {
          "type": "screen",
          "screenId": "B05",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEBALANCE"
        },
        {
          "type": "state",
          "screenId": "BP6",
          "STEP_FUNC": "DC_AMOUNT_ENTRY",
          "STEP_PARAM": "B06141137BP7255255255B07"
        },
        {
          "type": "screen",
          "screenId": "B06",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEENTER AMOUNT"
        },
        {
          "type": "screen",
          "screenId": "B07",
          "CONTENTS": "********",
          "WEB_USE_HTML_DIALOG": "0"
        },
        {
          "type": "state",
          "screenId": "BP7",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "B08141137BA1BA255255000"
        },
        {
          "type": "screen",
          "screenId": "B08",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEPLEASE WAIT"
        },
        {
          "type": "state",
          "screenId": "BA1",
          "STEP_FUNC": "DC_CLOSE_TRAN",
          "STEP_PARAM": "B09000B09B09000000000000"
        },
        {
          "type": "state",
          "screenId": "BA2",
          "STEP_FUNC": "DC_CLOSE_TRAN",
          "STEP_PARAM": "B10000B10B10000000000000"
        },
        {
          "type": "screen",
          "screenId": "B09",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAESUCCESSFUL"
        },
        {
          "type": "screen",
          "screenId": "B08",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEFAILED"
        },
        {
          "type": "state",
          "screenId": "PC1",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "P01141137BP5BA2255255000"
        },
        {
          "type": "screen",
          "screenId": "P01",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEAVAILABLE CREDIT CARDS"
        },
        {
          "type": "state",
          "screenId": "D01",
          "STEP_FUNC": "NDC_FDK_SELECT8",
          "STEP_PARAM": "D01141000D03D02012255000"
        },
        {
          "type": "screen",
          "screenId": "D01",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0e190\\\\0f@=B01\\\\CARDLESS TRANSACTIONS"
        },
        {
          "type": "state",
          "screenId": "D02",
          "STEP_FUNC": "NDC_EXT",
          "STEP_PARAM": "100300940770881700400200"
        },
        {
          "type": "state",
          "screenId": "D03",
          "STEP_FUNC": "NDC_FDK_SWITCH",
          "STEP_PARAM": "014000255255255255255255",
          "IDLE_B": ",,,,D01"
        },
        {
          "type": "screen",
          "screenId": "OS1",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEOTHER SERVICES"
        },
        {
          "type": "state",
          "screenId": "OS1",
          "STEP_FUNC": "NDC_FDK_SELECT8",
          "STEP_PARAM": "OS1141137OS3255255255"
        },
        {
          "type": "state",
          "screenId": "OS3",
          "STEP_FUNC": "NDC_FDK_SWITCH",
          "STEP_PARAM": "BP1EM1MS1ES1255255255255"
        },
        {
          "type": "state",
          "screenId": "CM1",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "CM1141137014255255255"
        },
        {
          "type": "screen",
          "screenId": "CM1",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAECOMMON SCREEN WITH 4 FDK"
        },
        {
          "type": "state",
          "screenId": "EM1",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "EM1141137OS2255255255"
        },
        {
          "type": "screen",
          "screenId": "EM1",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEEMAIL UPDATE"
        },
        {
          "type": "state",
          "screenId": "OS2",
          "STEP_FUNC": "DC_CLOSE_TRAN",
          "STEP_PARAM": "OS2000OS2000000000000"
        },
        {
          "type": "screen",
          "screenId": "OS2",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAE UPDATE TRANSACTION SUCCESSFUL"
        },
        {
          "type": "state",
          "screenId": "MS1",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "113141137255255255255"
        },
        {
          "type": "screen",
          "screenId": "MS1",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEMINI STATEMENT"
        },
        {
          "type": "state",
          "screenId": "ES1",
          "STEP_FUNC": "DC_FDK_SELECT4",
          "STEP_PARAM": "ES1141137ES2ES3255255"
        },
        {
          "type": "screen",
          "screenId": "ES1",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAEEMAIL AN RECEIPT"
        },
        {
          "type": "state",
          "screenId": "ES2",
          "STEP_FUNC": "DC_CLOSE_TRAN",
          "STEP_PARAM": "ES2000ES2000000000000"
        },
        {
          "type": "screen",
          "screenId": "ES2",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAE EMAIL SENT SUCCESS RESPONSE"
        },
        {
          "type": "state",
          "screenId": "ES3",
          "STEP_FUNC": "DC_CLOSE_TRAN",
          "STEP_PARAM": "ES2000ES3000000000000"
        },
        {
          "type": "screen",
          "screenId": "ES3",
          "CONTENTS": "\\\\1b(1\\\\0c\\\\0fAE SMS SENT SUCCESS RESPONSE"
        }
      ];
      const familyData = [
        {
          name: 'King George V',
          gender: 'M',
          status: 'king',
          born: '1865',
          death: '1936'
          // no parent value, this is the root
        },
        {
          name: 'King Edward VIII',
          gender: 'M', status: 'king', born: '1894', death: '1972',
          parent: 'King George V'
        },
        {
          name: 'King George VI',
          gender: 'M', status: 'king', born: '1895', death: '1952',
          parent: 'King George V'
        },
      ];
      const links = [];
      const linkRules = [
        {
          matchSourceFunc: 'NDC_FDK_SELECT8',
          matchTargetFunc: 'NDC_FDK_SWITCH',
          matchSourceParamChunk: 4,
          color: '#9b59b6',
          label: 'extension'

        },
        {
          matchSourceFunc: 'NDC_FDK_SELECT8',
          matchTargetFunc: 'NDC_EXT',
          matchSourceParamChunk: 5,
          color: '#9b59b6',
          label: 'extension'

        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 1,
          color: '#0d9f00',
          label: 'FDK A'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 2,
          color: '#0d9f00',
          label: 'FDK B'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 3,
          color: '#0d9f00',
          label: 'FDK C'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 4,
          color: '#0d9f00',
          label: 'FDK D'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 5,
          color: '#0d9f00',
          label: 'FDK F'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 6,
          color: '#0d9f00',
          label: 'FDK G'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 7,
          color: '#0d9f00',
          label: 'FDK H'
        },
        {
          matchSourceFunc: 'NDC_FDK_SWITCH',
          matchTargetFunc: null,
          matchSourceParamChunk: 7,
          color: '#0d9f00',
          label: 'FDK I'
        },
        {
          matchSourceFunc: 'DC_FDK_SELECT4',
          matchTargetFunc: null,
          matchSourceParamChunk: 4,
          color: '#91eb00',
          label: 'FDK A'
        },
        {
          matchSourceFunc: 'DC_FDK_SELECT4',
          matchTargetFunc: null,
          matchSourceParamChunk: 5,
          color: '#91eb00',
          label: 'FDK B'
        },
        {
          matchSourceFunc: 'DC_FDK_SELECT4',
          matchTargetFunc: null,
          matchSourceParamChunk: 6,
          color: '#91eb00',
          label: 'FDK C'
        },
        {
          matchSourceFunc: 'DC_FDK_SELECT4',
          matchTargetFunc: null,
          matchSourceParamChunk: 7,
          color: '#91eb00',
          label: 'FDK D'
        },
      ];
      const skipScreens_STEP_FUNC = ['NDC_FDK_SWITCH', 'NDC_EXT'];


      window.addEventListener('DOMContentLoaded', () => {
        // setTimeout only to ensure font is loaded before loading diagram
        // you may want to use an asset loading library for this
        // to keep this sample simple, it does not
        setTimeout(() => {
          regKeys = regKeys.map(node => ({
            ...node,
            name: (node.type || '') + '_' + (node.screenId || '')  // fallback if any field missing
          }));

          checkLinking()




          initDiagram('myDiagramDiv');
        }, 300);
      });
      function getStepParamChunk(stepParam, position) {
        if (!stepParam || position < 1 || position > 8) return null;

        const startIndex = (position - 1) * 3;
        return stepParam.substring(startIndex, startIndex + 3);
      }

      function checkLinking() {

        linkRules.forEach(rule => {
          regKeys.forEach(sourceNode => {
            if (sourceNode.STEP_FUNC === rule.matchSourceFunc) {
              regKeys.forEach(targetNode => {
                if (
                  (!rule.matchTargetFunc || targetNode.STEP_FUNC === rule.matchTargetFunc) &&
                  getStepParamChunk(sourceNode.STEP_PARAM, rule.matchSourceParamChunk) === targetNode.screenId
                ) {
                  links.push({
                    from: sourceNode.name,
                    to: targetNode.name,
                    color: rule?.color,
                    text: rule.label || ''
                  });
                }
              });
            }
          });
        });

      }
    </script>

    <div id="sample">
      <div id="myDiagramDiv" style="background-color: white; border: solid 1px black; width: 100%; height: 550px"></div>
      <p><button id="zoomToFit">Zoom to Fit</button> <button id="centerRoot">Center on root</button></p>
      <p id="hidden">this forces the font to load in Chromium browsers</p>
    </div>


  </div>
</body>

</html>